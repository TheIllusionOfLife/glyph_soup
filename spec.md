# Glyph Soup — 実装仕様書

> **Document Role:** Implementation Specification (authoritative)
> **Based on:**
> - [`research_plan.md`](research_plan.md) — 初期研究計画（構想・RQ・実験シナリオの原案）
> - [`review_unified.md`](review_unified.md) — 統一レビュー（計画の問題点と推奨アクション）
> - [`生命の起源とアセンブリ理論レポート.md`](生命の起源とアセンブリ理論レポート.md) — アセンブリ理論の参照資料
> - 研究者インタビュー — パラメータ選択・スコープ・設計判断の確定
>
> **This is the document to follow for implementation.** The research plan and review are retained for context and audit trail.

### Decision Status Legend

本仕様書の各項目は以下のいずれかの状態にある：

| マーク | 意味 |
|-------|------|
| (なし) | **確定済み** — そのまま実装してよい |
| **[EXPLORE]** | **探索項目** — 複数の選択肢を実装し、予備実験またはベンチマークで決定する |
| **[DEFERRED]** | **後決め項目** — 該当フェーズ開始時に決定する。実装をブロックしない |

---

## 1. システム概要

| 項目 | 決定事項 |
|------|---------|
| リポジトリ構成 | モノレポ（`glyph_soup/`に全コード） |
| 言語 | Python先行 → ボトルネック判明後にRustで最適化 |
| 実装基盤 | Rust/C拡張も視野に入れるが、まずPure Pythonで動作確認 |
| 出力形式 | CSV出力 + Jupyter Notebookで分析・可視化 |
| ゲームエンジン連携 | **[DEFERRED]** Python完成後に最適なエンジン（Unity/Unreal/Godot等）を選定 |
| スコープ | 全実験（A・B・C）+ ゲームエンジンによる視覚化 |

---

## 2. データ構造

### 2.1 分子の内部表現：二分木

分子は二分木（Binary Tree）で表現する。文字列表現は表示・ハッシュ比較用。

```
分子 ((A,B),(C,D)) の木表現:

       *
      / \
     *   *
    / \ / \
   A  B C  D
```

### 2.2 結合の対称性 **[EXPLORE]**

- **(A,(B,C))** と **((B,C),A)** を同一とみなすか否かは実験パラメータとして扱う
- 両条件（対称/非対称）を実装し、ダイナミクスの差異を比較する
- 対称モードでは正規形（canonical form）への変換が必要

---

## 3. シミュレーションパラメータ

| パラメータ | 値 | 備考 |
|-----------|-----|------|
| アルファベットサイズ | 4種（A, B, C, D） | 固定 |
| タンク初期原子数 | ~1,000 | 初期投入量。Open Systemのため上限なし |
| タンク原子数上限 | なし（Open System） | 実験C-1で初めて上限を導入する |
| 1ランのステップ数 | 100,000 | 固定 |
| seed数（各実験条件） | 100回 | 固定（0-99） |

---

## 4. 指標体系（3層設計）

レビューで指摘されたC1（指標の乖離）を解決するため、3層の指標を定義する。

### 4.1 個別指標（分子種レベル）

$$S_i = A_i \times N_i$$

各分子種$i$のアセンブリ指数$A_i$とコピー数$N_i$の積。ヒートマップ（MA-CN散布図）のプロット用。

### 4.2 系全体指標

$$A_{total} = \sum_{i} (A_i \times N_i)$$

系全体のアセンブリ状態を定量化。相転移検出の主要指標。

### 4.3 分布形状指標

MA-CN散布図のクラスタ形成パターンを分析し、以下を区別する：
- **ランダムな複雑さ**: 高$A$・低$N$（偶然の産物）
- **組織化された複雑さ**: 中〜高$A$・極めて高$N$（選択と複製の結果）

---

## 5. MA計算アルゴリズム

### 5.1 方針

**近似解（貪欲法＋キャッシュ）** を採用する。

- 貪欲法で最大の再利用可能サブ構造を優先的にマッチする
- 計算済みMAをキャッシュし、同一構造の再計算を回避
- 厳密解との乖離率は初期ベンチマーク時に確認する

### 5.2 ベンチマーク要件

プロジェクト最初期にプロトタイプ実装し、以下を計測する：
- 分子長（ノード数） vs 計算時間
- 近似解 vs 厳密解（小規模サンプル）の乖離率
- タンク全分子のMA一括計算のスループット

---

## 6. 反応ルール

### 6.1 Bonding（結合）

```
X + Y → Join(X, Y)    確率: P_bond
```

- 結合位置：二分木のルートに新ノードを作り、X・Yを左右の子とする
- `P_bond` は定数、値域 $[0, 1]$ **[EXPLORE]**
- **初期値**: 0.5（Phase 3のベンチマーク後、平衡到達時間を見て調整）
- **探索範囲**: {0.1, 0.3, 0.5, 0.7, 0.9} のグリッドサーチ（実験A予備実験で決定）

### 6.2 Breaking（分解）

```
Join(X, Y) → X + Y    確率: P_break(molecule)
```

- 切断位置：二分木の内部ノードを一様ランダムに選択し、そこで切断
- 分解確率関数 `P_break` は**実験パラメータ [EXPLORE]** として以下を比較する：
  - **線形**: $P_{break}(n) = \min(1,\; \beta \cdot n)$
  - **指数**: $P_{break}(n) = \min(1,\; \beta \cdot \exp(\alpha \cdot n))$
  - **ノード数比例**: $P_{break}(m) = \min(1,\; \beta \cdot m)$ （$m$ = 内部ノード数）
- すべて $\min(1, \cdot)$ で $[0, 1]$ にクランプする
- $\alpha, \beta$ は調整パラメータ。初期値は予備実験で平衡到達を確認して設定する

### 6.3 Catalysis（触媒）[Phase 2: 実験B以降]

```
X + Y + C → Join(X, Y) + C    確率: P_bond × boost(C, X, Y)
```

#### 反応の実行手順

1. タンクから2分子 (X, Y) を一様ランダムにサンプリングする（非復元抽出）
2. タンク内の**残りの**分子から触媒候補 C を1つ一様ランダムにサンプリングする
3. C が (X, Y) の結合を触媒するかマッチング判定する
4. マッチした場合、結合確率を `P_bond × boost` に引き上げる
5. C はタンクに戻す（触媒は消費されない）
- **同一分子の多重使用**: 不可（X, Y, C はすべて異なる個体）
- **濃度依存**: ステップ2でタンクからランダム抽出するため、コピー数が多い分子ほど触媒として選ばれやすい（暗黙的な濃度依存）

#### 方式1: 構造決定論的

- **文字列部分一致**: 触媒のフラット表現が基質のフラット表現に含まれるか
- **木構造部分一致**: 触媒の部分木が基質の部分木と同型か
- 両方実装し、「触媒記述の解像度」がダイナミクスに与える影響を比較

#### 方式2: ランダムテーブル

- seedごとにランダムな触媒マップを生成
- 設計者バイアスを排除し、創発の主張を堅固にする

---

## 7. 閾値の再校正（C2対処）

参照理論の $A > 15$ は実分子測定の経験的境界であり、文字列人工化学にそのまま移植しない。

### 校正手順

1. 実験A（ランダム条件）を100 seedで実行
2. 各seedにおける$A_{total}$と最大MAの分布を取得
3. 分布の99パーセンタイルを「ランダム上限」とする
4. この上限を超える状態を「非ランダム領域」と定義
5. 以降の実験B・Cの判定基準として使用

---

## 8. アセンブリ転移の操作的定義

**$A_{total}$ の時系列における急激かつ持続的な勾配変化**をもって「転移」と判定する。

### 8.1 検出アルゴリズム

1. $A_{total}$ の時系列に対し、窓幅 $W$ の移動平均でノイズを平滑化する
2. 平滑化済み時系列の二階差分（加速度）$a(t)$ を計算する
3. $a(t)$ が閾値 $\theta$ を**連続 $k$ ステップ**超えた場合に「転移開始」と判定する

### 8.2 パラメータ

| パラメータ | 初期値 | 校正方法 |
|-----------|-------|---------|
| 窓幅 $W$ | 1,000ステップ | 予備実験で平滑化後のSN比を確認して調整 |
| 持続条件 $k$ | 500ステップ | 実験Aのランダム条件で偽陽性率 < 1% になる値を選定 |
| 閾値 $\theta$ | — | 実験Aのランダム条件での $a(t)$ 分布の99パーセンタイルに設定 |

### 8.3 設計根拠

- 連続$k$ステップ超過の持続条件により、単発スパイクの誤検出を排除する
- $W$, $k$, $\theta$ のすべてを実験Aのベースライン分布から校正するため、恣意性を最小化する

---

## 9. 統計計画

### 9.1 要約値の定義

各seedの $A_{total}$ 時系列（100Kステップ）から以下の3値を抽出する：

| 要約値 | 定義 | 役割 |
|--------|------|------|
| 安定期平均 $\bar{A}_{stable}$ | 後半50%ステップ（50K-100K）の $A_{total}$ 平均 | **主指標**: 条件間比較の基準値 |
| 終点値 $A_{end}$ | 最終ステップの $A_{total}$ | 副指標: 到達状態の確認 |
| AUC | 全ステップの $A_{total}$ の曲線下面積（台形近似） | 副指標: 一時的上昇と持続的上昇の判別 |

### 9.2 検定手法

| 項目 | 値 |
|------|-----|
| seed数 | 100（各実験条件） |
| seed管理 | 固定（0-99）で再現性を保証 |
| 主指標の比較検定 | Mann-Whitney U検定（$\bar{A}_{stable}$ の条件間比較。正規性を仮定しない） |
| 分布全体の比較 | KS検定（$\bar{A}_{stable}$ の分布形状が条件間で異なるかを補助的に検定） |
| 効果量 | rank-biserial correlation $r$（Mann-Whitney U検定に対応するノンパラメトリック効果量） |
| 報告 | 95%信頼区間（ブートストラップ法） |

### 9.3 設計根拠

- $A_{total}$ の分布は正規性が保証されないため、ノンパラメトリック検定（Mann-Whitney U）を主検定とする
- KS検定は分布形状の差異を補助的に検出する（平均差がなくても分散や歪度が異なる場合を捕捉）
- 効果量は検定手法と整合したrank-biserial correlationを使用し、Cohen's dのような正規性前提の指標との不整合を回避する

---

## 10. 実験設計

### 実験A: 帰無仮説検証（ベースライン）

- **条件**: ランダムなBonding/Breaking。触媒なし。Open System（原子数上限なし）。初期原子数~1,000。
- **目的**: ランダム条件でのMA分布上限を確立し、独自閾値を校正する。
- **出力**: $A_{total}$時系列、MA分布、MA-CN散布図、転移判定パラメータの校正値

### 実験B: 自己触媒の効果

- **条件**: 実験Aと同じOpen System + 触媒メカニズムを追加
- **サブ条件**:
  - B-1: 構造決定論的触媒（文字列部分一致）
  - B-2: 構造決定論的触媒（木構造部分一致）
  - B-3: ランダムテーブル触媒
- **目的**: 触媒導入によるMA分布・$A_{total}$の変化を定量化。触媒記述方式による差異を分析。

### 実験C: 非限定的進化（アブレーション設計）

4因子を以下の順で1つずつ追加する。ベースは**実験Bの最良条件（Open System + 触媒）**。

| サブ実験 | 追加因子 | ベースとの差分 |
|---------|---------|--------------|
| C-1 | 資源競合 | Open Systemに総原子数上限（1,000）を導入。結合で新原子は生まれず、分解しても原子は系内に残留。 |
| C-2 | 触媒耐性 | C-1 + 触媒マッチする分子の $P_{break}$ を $\gamma$ 倍に低減（$\gamma < 1$） |
| C-3 | 突然変異 | C-2 + 各ステップで確率 $\mu$ で葉ノードの文字がランダムに変化 |
| C-4 | エネルギー効率 | C-3 + 分子の内部ノード数に比例した維持コスト。毎ステップ確率的に自然分解。 |

各サブ実験で100 seed × 100Kステップ。前段の結果と比較。

> **Note:** 実験A・Bは**Open System**（原子数上限なし）で実行する。C-1で初めて原子数上限を導入することで、「資源制約の有無」が明確な介入変数となる。

---

## 11. プロジェクト構成（モノレポ）

```
glyph_soup/
├── research_plan.md          # 研究計画書（原本）
├── review_unified.md         # 統一レビュー
├── spec.md                   # 本仕様書
├── src/
│   ├── glyph_soup/
│   │   ├── __init__.py
│   │   ├── molecule.py       # 二分木データ構造
│   │   ├── assembly.py       # MA計算アルゴリズム
│   │   ├── reactor.py        # Reactor（タンク管理）
│   │   ├── chemist.py        # Chemist（反応ルール）
│   │   ├── observer.py       # Observer（指標計算・CSV出力）
│   │   └── config.py         # パラメータ管理
│   └── rust_core/            # [将来] Rust高速化モジュール
├── experiments/
│   ├── exp_a/                # 実験A: ベースライン
│   ├── exp_b/                # 実験B: 触媒
│   └── exp_c/                # 実験C: アブレーション
├── notebooks/
│   ├── analysis_a.ipynb      # 実験A分析
│   ├── analysis_b.ipynb      # 実験B分析
│   └── analysis_c.ipynb      # 実験C分析
├── game/                     # [将来] ゲームエンジンプロジェクト
├── tests/
├── pyproject.toml
└── README.md
```

---

## 12. 開発フェーズ

### Phase 1: コア実装 + ベンチマーク
- 二分木データ構造（`molecule.py`）
- MA計算アルゴリズム（`assembly.py`）+ ベンチマーク
- 対称性の両モード実装

### Phase 2: シミュレーションエンジン
- Reactor, Chemist, Observer の実装
- パラメータ管理（`config.py`）
- CSV出力

### Phase 3: 実験A + 閾値校正
- 100 seed × 100Kステップのバッチ実行
- 分析Notebook作成
- Glyph Soup固有の閾値確立

### Phase 4: 実験B（触媒）
- 触媒メカニズム3方式の実装
- 比較分析

### Phase 5: 実験C（アブレーション）
- 4因子の段階的追加（資源競合→触媒耐性→突然変異→エネルギー効率）
- 各段階での比較分析

### Phase 6: ゲームエンジン視覚化 [DEFERRED]
- エンジン選定（連携の容易さで判断）
- Python ↔ エンジン間通信の実装
- リアルタイム可視化

### Phase 7: Rust最適化 [DEFERRED]
- Phase 3以降でボトルネックが判明した場合に実行
- MA計算 or Reactor のホットパスをRustで再実装
